#!/usr/bin/make -f
# -*- makefile -*-

#export DH_VERBOSE=1

include /usr/share/dpatch/dpatch.make

DESTDIR := $(CURDIR)/debian/menhir
OCAMLABI := $(shell ocamlc -version)
IS_NATIVE:= $(wildcard /usr/bin/ocamlopt)
TARGET   := $(if $(IS_NATIVE),opt,byte)
STRIPOPT := -e "$(if $(IS_NATIVE),,/native/d)"
OCAML_IN_FILES := $(filter-out debian/control,$(patsubst %.in,%,$(wildcard debian/*.in)))

ocamlinit: ocamlinit-stamp
ocamlinit-stamp:
	for t in $(OCAML_IN_FILES); do \
          sed -e 's%@OCAMLABI@%$(OCAMLABI)%' $$t.in > $$t; \
        done
	sed $(STRIPOPT) src/META > META
	touch $@

ocamlinit-clean:
	rm -f $(OCAML_IN_FILES)

build: ocamlinit build-stamp
build-stamp: patch-stamp
	dh_testdir
	$(MAKE) TARGET=$(TARGET) PREFIX=/usr
	dh build --after auto_build
	touch $@

clean: unpatch ocamlinit-clean
	dh clean
	$(MAKE) -C src/ clean PREFIX=$(CURDIR)/debian/menhir/usr

install: build install-stamp
install-stamp:
	dh install --before auto_install
	cp src/menhir.$(TARGET) $(DESTDIR)/usr/bin/menhir
	dh install --after auto_install
	touch $@

# Build architecture-independent files here.
binary-indep: install-stamp

# Build architecture-dependent files here.
binary-arch: install-stamp
	echo 'F:OCamlAbi=$(OCAMLABI)' >> debian/menhir.substvars
	dh $@

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure patch unpatch
