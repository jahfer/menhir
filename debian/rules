#!/usr/bin/make -f
# -*- makefile -*-

export DH_VERBOSE=1

include /usr/share/dpatch/dpatch.make
include /usr/share/ocaml/ocamlvars.mk
include /usr/share/ocaml/ocamlinit.mk

DESTDIR := $(CURDIR)/debian/menhir
STRIPOPT := $(if $(OCAML_OPT_ARCH),-e "",-e "/native/d")

build: ocamlinit-stamp build-stamp
build-stamp: patch-stamp
	dh_testdir
	$(MAKE) TARGET=$(OCAML_BEST) PREFIX=/usr
	sed $(STRIPOPT) src/META > META
	dh build --after auto_build
	touch $@

clean: unpatch ocamlinit-clean
	dh clean
	$(MAKE) -C src/ clean PREFIX=$(DESTDIR)/usr

install: build install-stamp
install-stamp:
	dh install --before auto_install
	cp src/menhir.$(OCAML_BEST) $(DESTDIR)/usr/bin/menhir
	dh install --after auto_install
	touch $@

binary-indep: install-stamp

binary-arch: install-stamp
	echo 'F:OCamlAbi=$(OCAML_ABI)' >> debian/menhir.substvars
	dh $@

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure patch unpatch
