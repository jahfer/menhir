#!/usr/bin/make -f
# -*- makefile -*-

export DH_VERBOSE=1

include /usr/share/dpatch/dpatch.make
include /usr/share/ocaml/ocamlvars.mk
include /usr/share/ocaml/ocamlinit.mk

DESTDIR := $(CURDIR)/debian/menhir
ifeq ($(OCAML_HAVE_OCAMLOPT), yes)
  TARGET   := opt
else
  TARGET   := byte
endif

build: ocamlinit-stamp build-stamp
build-stamp: patch-stamp
	dh_testdir
	$(MAKE) TARGET=$(TARGET) PREFIX=/usr
ifeq ($(OCAML_HAVE_OCAMLOPT), no)
	sed -e "/native/d" src/META > META
endif
	dh build --after auto_build
	touch $@

clean: unpatch ocamlinit-clean
	dh clean
	$(MAKE) -C src/ clean PREFIX=$(CURDIR)/debian/menhir/usr

install: build install-stamp
install-stamp:
	dh install --before auto_install
	cp src/menhir.$(TARGET) $(DESTDIR)/usr/bin/menhir
	dh install --after auto_install
	touch $@

binary-indep: install-stamp

binary-arch: install-stamp
	echo 'F:OCamlAbi=$(OCAML_ABI)' >> debian/menhir.substvars
	dh $@

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure patch unpatch
